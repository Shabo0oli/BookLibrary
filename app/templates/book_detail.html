{% extends "base.html" %}
{% from "bootstrap/pagination.html" import render_pagination %}
{% import "bootstrap/wtf.html" as wtf %}
{% block mycontent %}
    <div class="jumbotron">
        <div class="well well-lg">

            <h1 class="page-header">{{ book.title }}
                <br>
                {%- if book.subtitle %}
                    <small>{{ book.subtitle }}</small>
                {% endif -%}
            </h1>
            <div class="primary-info">
                {% if book.image %}
                    <img class="img-responsive" src="{{ book.image }}" alt="{{ book.title~' 封面' }}">
                {% endif %}
                <ul class="list-group">
                    <li class="list-group-item">ISBN: {{ book.isbn }}</li>
                    {%- if book.origin_title -%}
                        <li class="list-group-item">原作名: {{ book.origin_title }}</li>
                    {%- endif -%}
                    {%- if book.author -%}
                        <li class="list-group-item">作者: {{ book.author }}</li>
                    {%- endif -%}
                    {%- if book.translator -%}
                        <li class="list-group-item">译者: {{ book.translator }}</li>
                    {%- endif -%}
                    {%- if book.publisher -%}
                        <li class="list-group-item">出版社: {{ book.publisher }}</li>
                    {%- endif -%}
                    {%- if book.pubdate -%}
                        <li class="list-group-item">出版日期: {{ book.pubdate }}</li>
                    {%- endif -%}
                    {%- if book.tags -%}
                        <li class="list-group-item">标签: {{ book.tags }}</li>
                    {%- endif -%}
                    {%- if book.price -%}
                        <li class="list-group-item">定价: {{ book.price }}</li>
                    {%- endif -%}
                    {%- if book.binding -%}
                        <li class="list-group-item">装帧: {{ book.binding }}</li>
                    {%- endif -%}
                    <li class="list-group-item">馆藏 / 可借: {{ book.numbers }} / {{ book.can_borrow_number() }}</li>
                </ul>
            </div>
            <br>
            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingOne">
                        <h4 class="panel-title">
                            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#summary"
                               aria-expanded="true" aria-controls="collapseOne">
                                内容简介
                            </a>
                        </h4>
                    </div>
                    <div id="summary" class="panel-collapse collapse in" role="tabpanel"
                         aria-labelledby="headingOne">
                        <div class="panel-body">
                            {% if book.summary_html %}
                                {{ book.summary_html|safe }}
                            {% else %}
                                {{ book.summary }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="catalog">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                               href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                目录
                            </a>
                        </h4>
                    </div>
                    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingTwo">
                        <div class="panel-body">
                            {% if book.catalog_html %}
                                {{ book.catalog_html|safe }}
                            {% else %}
                                {{ book.catalog }}
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>

            <div class="btn-group">
                {%- if g.user.is_authenticated -%}
                    {% with  log=g.user.borrowing(book) %}
                        {%- if log -%}
                            <a class="btn btn-primary"
                               href="{{ url_for('book_return',lid=log.id,next=request.full_path ) }}">
                                归还
                            </a>
                        {%- else -%}
                            <a class="btn btn-success"
                               href="{{ url_for('book_borrow',bid=book.id,next=request.full_path) }}"
                               {% if not book.can_borrow() %}disabled="disabled"{% endif %}>
                                借阅
                            </a>
                        {%- endif -%}
                    {% endwith %}
                {%- endif -%}
                {%- if g.user.admin -%}
                    <a type="button" class="btn btn-warning" href="{{ url_for('book_edit',bid=book.id) }}">编辑书籍信息
                    </a>
                {%- endif -%}
            </div>
        </div>
        <div class="well well-lg">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist" id="log">
                {% with tabindex= request.args.get('show') or '0' %}
                    <li role="presentation" {% if tabindex=='0' %}class="active"{% endif %}><a
                            href="{% if tabindex=='0' %}#log{% else %}{{ url_for('book_detail',bid=book.id,show=0,_anchor='log') }}{% endif %}"
                            role="tab">书评</a></li>
                    <li role="presentation" {% if tabindex=='1' %}class="active"{% endif %}><a
                            href="{% if tabindex=='1' %}#log{% else %}{{ url_for('book_detail',bid=book.id,show=1,_anchor='log') }}{% endif %}"
                            role="tab">当前借阅信息</a></li>
                    <li role="presentation" {% if tabindex=='2' %}class="active"{% endif %}><a
                            href="{% if tabindex=='2' %}#log{% else %}{{ url_for('book_detail',bid=book.id,show=2,_anchor='log') }}{% endif %}"
                            role="tab">历史借阅信息</a></li>
                {% endwith %}
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                {% if (request.args.get('show') or '0')=='0' %}

                    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
                        写书评
                    </button>
                    {% for comment in data %}
                        <div class="media">
                            {% if comment.user.avatar %}
                                <div class="media-left">
                                    <a href="{{ url_for('user_detail',uid=comment.user.id) }}">
                                        <img class="media-object" src="{{ comment.user.avatar }}"
                                             alt="{{ comment.user.name }}">
                                    </a>
                                </div>
                            {% endif %}
                            <div class="media-body">
                                <h4 class="media-heading">{{ comment.user.about_me or "" }}</h4>
                                {{ comment.comment }}
                            </div>
                        </div>
                    {% endfor %}
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                            aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title">{{ g.user.name~' 对 '~book.title~' 的书评' }}</h4>
                                </div>
                                <form action="{{ url_for('book_comment',bid=book.id) }}" method="post" class="form"
                                      role="form">
                                    {{ form.hidden_tag() }}
                                    <div class="modal-body">
                                        <div class="form-group  required">
                                            {{ form.comment.label(class_="control-label") }}
                                            {{ form.comment(class_="form-control",required_="required") }}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                                        </button>
                                        <input class="btn btn-primary" id="submit" name="submit" type="submit"
                                               value="发布"></div>
                                </form>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal-dialog -->
                    </div><!-- /.modal -->

                {% elif request.args.get('show')=='1' %}
                    {% if data %}
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>用户名</th>
                                <th class="hidden-xs">用户邮箱</th>
                                <th>借阅日期</th>
                                <th>归还日期</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for log in data %}
                                <tr>
                                    <td><a href="{{ url_for('user_detail' ,uid=log.user.id) }}">{{ log.user.name }}</a>
                                    </td>
                                    <td class="hidden-xs">{{ log.user.email }}</td>
                                    </td>
                                    <td>{{ log.borrow_timestamp.strftime('%d %B %Y - %H:%M:%S') }}</td>
                                    <td>{{ log.return_timestamp.strftime('%d %B %Y - %H:%M:%S') }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="container-fluid">暂无信息</div>
                    {% endif %}
                {% else %}
                    {% if data %}
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>用户名</th>
                                <th class="hidden-xs">用户邮箱</th>
                                <th>借阅日期</th>
                                <th>归还日期</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for log in data %}
                                <tr>
                                    <td><a href="{{ url_for('user_detail' ,uid=log.user.id) }}">{{ log.user.name }}</a>
                                    </td>
                                    <td class="hidden-xs">{{ log.user.email }}</td>
                                    </td>
                                    <td>{{ log.borrow_timestamp.strftime('%d %B %Y - %H:%M:%S') }}</td>
                                    <td>{{ log.return_timestamp.strftime('%d %B %Y - %H:%M:%S') }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="container-fluid">暂无信息</div>
                    {% endif %}

                {% endif %}
            </div>

            {% if pagination and pagination.pages > 1 %}
                <div class="container-fluid text-center">
                    {{ render_pagination(pagination,args={'_anchor':'log'}) }}
                </div>
            {% endif %}
        </div>
{% endblock %}